name: "Kubernetes Deployment Summary"
description: "Generate GitHub Summary for K8s resource (Deployment, StatefulSet, or DaemonSet)"
author: "DevOps Bot"

inputs:
  namespace:
    required: true
  app_name:
    required: true
  notify_users:
    required: false
    default: ""

outputs:
  result:
    description: "success or failure"

runs:
  using: "composite"
  steps:

    - name: Kubernetes Deployment Summary
      shell: bash
      run: |
        set -euo pipefail

        NS="${{ inputs.namespace }}"
        APP="${{ inputs.app_name }}"
        USERS="${{ inputs.notify_users }}"

        echo "ðŸ”Ž Detecting resource type..."

        DEP=$(kubectl get deploy "$APP" -n "$NS" --ignore-not-found --no-headers | wc -l)
        STS=$(kubectl get statefulset "$APP" -n "$NS" --ignore-not-found --no-headers | wc -l)
        DS=$(kubectl get daemonset "$APP" -n "$NS" --ignore-not-found --no-headers | wc -l)

        if [ "$DEP" -eq 1 ]; then
          RESOURCE_TYPE="deployment"
        elif [ "$STS" -eq 1 ]; then
          RESOURCE_TYPE="statefulset"
        elif [ "$DS" -eq 1 ]; then
          RESOURCE_TYPE="daemonset"
        else
          echo "âŒ Resource '$APP' not found in '$NS'"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "â³ Checking rollout status for $RESOURCE_TYPE/$APP ..."
        if kubectl rollout status $RESOURCE_TYPE/"$APP" -n "$NS" --timeout=120s; then
          RESULT="success"
        else
          RESULT="failure"
        fi

        # Identify pods managed by this workload
        PODS_RAW=$(kubectl get pods -n "$NS" -l app="$APP" \
            -o=custom-columns=NAME:.metadata.name,READY:.status.containerStatuses[*].ready,STATE:.status.phase,RESTARTS:.status.containerStatuses[*].restartCount,NODE:.spec.nodeName --no-headers || true)

        echo "## ðŸš€ Kubernetes Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace:** $NS" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource:** $RESOURCE_TYPE/$APP" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by:** @${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### ðŸ” Pods" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "$PODS_RAW" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        # Detect bad pods: RestartCount > 0 OR CrashLoopBackOff OR Error
        BAD_PODS=$(kubectl get pods -n "$NS" -l app="$APP" \
            -o json | jq -r '.items[] | select(
                (.status.containerStatuses[]?.restartCount // 0) > 0 or
                (.status.containerStatuses[]?.state.waiting.reason == "CrashLoopBackOff") or
                (.status.containerStatuses[]?.state.waiting.reason == "Error")
            ) | .metadata.name')

        if [ -n "$BAD_PODS" ]; then
          RESULT="failure"

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Problematic Pods Detected" >> $GITHUB_STEP_SUMMARY

          if [ -n "$USERS" ]; then
            echo "- Notifying: $(echo "$USERS" | sed 's/,/ @/g' | sed 's/^/@/')" >> $GITHUB_STEP_SUMMARY
          fi

          for P in $BAD_PODS; do
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### âŒ Pod: $P" >> $GITHUB_STEP_SUMMARY

            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl describe pod "$P" -n "$NS" || true
            echo '```' >> $GITHUB_STEP_SUMMARY

            echo '```' >> $GITHUB_STEP_SUMMARY
            kubectl logs "$P" -n "$NS" --all-containers --tail=200 || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          done
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ•‘ Recent Namespace Events" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        kubectl get events -n "$NS" --sort-by=.metadata.creationTimestamp | tail -n 50 || true
        echo '```' >> $GITHUB_STEP_SUMMARY

        echo "result=$RESULT" >> $GITHUB_OUTPUT
