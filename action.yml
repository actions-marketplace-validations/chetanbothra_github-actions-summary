name: "Kubernetes Deployment Summary"
description: "Generate GitHub Summary for K8s resource (Deployment, StatefulSet, or DaemonSet)"
author: "DevOps Bot"

inputs:
  namespace:
    required: true
  app_name:
    required: true
  notify_users:
    required: false
    default: ""

outputs:
  result:
    description: "success or failure"

runs:
  using: "composite"
  steps:
    - name: Kubernetes Deployment Summary
      shell: bash
      run: |
        set -eo pipefail

        NS="${{ inputs.namespace }}"
        APP="${{ inputs.app_name }}"
        USERS="${{ inputs.notify_users }}"

        echo "ðŸ”Ž Detecting resource type..."

        if kubectl get deploy "$APP" -n "$NS" >/dev/null 2>&1; then
          RESOURCE_TYPE="deployment"
        elif kubectl get statefulset "$APP" -n "$NS" >/dev/null 2>&1; then
          RESOURCE_TYPE="statefulset"
        elif kubectl get daemonset "$APP" -n "$NS" >/dev/null 2>&1; then
          RESOURCE_TYPE="daemonset"
        else
          echo "âŒ Resource '$APP' not found"
          echo "result=failure" >> "$GITHUB_OUTPUT"
          exit 1
        fi

        echo "â³ Waiting for rollout to complete..."
        if kubectl rollout status "$RESOURCE_TYPE/$APP" -n "$NS" --timeout=5m; then
          ROLLOUT_OK=true
        else
          ROLLOUT_OK=false
        fi

        # Allow Kubernetes to clean up old pods
        sleep 10

        # Fetch CURRENT pods only
        PODS_JSON=$(kubectl get pods -n "$NS" -l app="$APP" -o json)

        echo "## ðŸš€ Kubernetes Deployment Summary" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Namespace:** $NS" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Resource:** $RESOURCE_TYPE/$APP" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Triggered by:** @${GITHUB_ACTOR}" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"

        echo "### ðŸ” Current Pods" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"

        echo "$PODS_JSON" | jq -r '
          .items[] |
          .metadata.name as $name |
          .status.phase as $phase |
          (
            [.status.containerStatuses[]?.ready] | map(select(.==true)) | length
          ) as $ready |
          (
            [.status.containerStatuses[]?] | length
          ) as $total |
          (
            [.status.containerStatuses[]?.restartCount] | add // 0
          ) as $restarts |
          "\($name)   \($ready)/\($total)   \($phase)   restarts=\($restarts)"
        ' >> "$GITHUB_STEP_SUMMARY"

        echo '```' >> "$GITHUB_STEP_SUMMARY"

        echo "### âš ï¸ Checking for real failures (live pods only)..." >> "$GITHUB_STEP_SUMMARY"

        BAD_PODS=$(echo "$PODS_JSON" | jq -r '
          .items[]
          | select(
              (.status.phase == "Failed")
              or (
                .status.containerStatuses[]?.state.waiting.reason
                | IN("CrashLoopBackOff", "CreateContainerConfigError", "InvalidImageName")
              )
          )
          | .metadata.name
        ')

        FAILURE=false

        if [ -n "$BAD_PODS" ]; then
          FAILURE=true
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### âŒ Problematic Pods (Currently Existing)" >> "$GITHUB_STEP_SUMMARY"

          for P in $BAD_PODS; do
            if kubectl get pod "$P" -n "$NS" >/dev/null 2>&1; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "#### $P" >> "$GITHUB_STEP_SUMMARY"

              echo '```' >> "$GITHUB_STEP_SUMMARY"
              kubectl describe pod "$P" -n "$NS" || true
              echo '```' >> "$GITHUB_STEP_SUMMARY"

              echo '```' >> "$GITHUB_STEP_SUMMARY"
              kubectl logs "$P" -n "$NS" --all-containers --tail=200 || true
              echo '```' >> "$GITHUB_STEP_SUMMARY"
            else
              echo "_Pod $P was terminated during rollout â€” ignoring._" >> "$GITHUB_STEP_SUMMARY"
            fi
          done
        fi

        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### ðŸ•‘ Recent Events (last 30)" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        kubectl get events -n "$NS" --sort-by='.metadata.creationTimestamp' | tail -30 || true
        echo '```' >> "$GITHUB_STEP_SUMMARY"

        # Final decision logic
        if [ "$ROLLOUT_OK" = true ] && [ "$FAILURE" = false ]; then
          echo "âœ… Rollout successful and no failing pods detected"
          echo "result=success" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "âŒ Deployment has real issues"
        echo "result=failure" >> "$GITHUB_OUTPUT"
        exit 1
